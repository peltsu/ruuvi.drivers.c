<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>ruuvi.drivers.c: Flash tasks</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ruuvi.drivers.c
   &#160;<span id="projectnumber">0.1.3</span>
   </div>
   <div id="projectbrief">Drivers for external sensors and peripherals on embedded systems.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__flash__tasks.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">Flash tasks<div class="ingroups"><a class="el" href="group__peripheral__tasks.html">Peripheral tasks</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Non-volatile storage functions.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga5d38001292abc41bab659d2b6da1691c"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group___error.html#ga3e1919cc1fe75cb7f12af047f6f4ce55">rd_status_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__tasks.html#ga5d38001292abc41bab659d2b6da1691c">rt_flash_init</a> (void)</td></tr>
<tr class="memdesc:ga5d38001292abc41bab659d2b6da1691c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize flash storage.  <a href="#ga5d38001292abc41bab659d2b6da1691c">More...</a><br/></td></tr>
<tr class="separator:ga5d38001292abc41bab659d2b6da1691c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gad44b23bace6d3792869483d1e99aa778"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group___error.html#ga3e1919cc1fe75cb7f12af047f6f4ce55">rd_status_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__tasks.html#gad44b23bace6d3792869483d1e99aa778">rt_flash_store</a> (const uint16_t file_id, const uint16_t record_id, const void *const message, const size_t message_length)</td></tr>
<tr class="memdesc:gad44b23bace6d3792869483d1e99aa778"><td class="mdescLeft">&#160;</td><td class="mdescRight">Store data to flash.  <a href="#gad44b23bace6d3792869483d1e99aa778">More...</a><br/></td></tr>
<tr class="separator:gad44b23bace6d3792869483d1e99aa778"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga8f66597592c4c5d6bf0c62c7967f75e2"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group___error.html#ga3e1919cc1fe75cb7f12af047f6f4ce55">rd_status_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__tasks.html#ga8f66597592c4c5d6bf0c62c7967f75e2">rt_flash_load</a> (const uint16_t file_id, const uint16_t record_id, void *const message, const size_t message_length)</td></tr>
<tr class="memdesc:ga8f66597592c4c5d6bf0c62c7967f75e2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Load data from flash.  <a href="#ga8f66597592c4c5d6bf0c62c7967f75e2">More...</a><br/></td></tr>
<tr class="separator:ga8f66597592c4c5d6bf0c62c7967f75e2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga3ed5adfa11e69215662fb393fd98c254"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__tasks.html#ga3ed5adfa11e69215662fb393fd98c254">rt_flash_busy</a> (void)</td></tr>
<tr class="memdesc:ga3ed5adfa11e69215662fb393fd98c254"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check if flash is running an operation.  <a href="#ga3ed5adfa11e69215662fb393fd98c254">More...</a><br/></td></tr>
<tr class="separator:ga3ed5adfa11e69215662fb393fd98c254"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga88b74f81127b1cab4fc6fd714e3cbcde"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group___error.html#ga3e1919cc1fe75cb7f12af047f6f4ce55">rd_status_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__tasks.html#ga88b74f81127b1cab4fc6fd714e3cbcde">rt_flash_free</a> (const uint16_t file_id, const uint16_t record_id)</td></tr>
<tr class="memdesc:ga88b74f81127b1cab4fc6fd714e3cbcde"><td class="mdescLeft">&#160;</td><td class="mdescRight">Free data from flash.  <a href="#ga88b74f81127b1cab4fc6fd714e3cbcde">More...</a><br/></td></tr>
<tr class="separator:ga88b74f81127b1cab4fc6fd714e3cbcde"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga4f22c6d5f9c1b27a03870d46dde214c2"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group___error.html#ga3e1919cc1fe75cb7f12af047f6f4ce55">rd_status_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__tasks.html#ga4f22c6d5f9c1b27a03870d46dde214c2">rt_flash_gc_run</a> (void)</td></tr>
<tr class="memdesc:ga4f22c6d5f9c1b27a03870d46dde214c2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Trigger garbage collection.  <a href="#ga4f22c6d5f9c1b27a03870d46dde214c2">More...</a><br/></td></tr>
<tr class="separator:ga4f22c6d5f9c1b27a03870d46dde214c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Non-volatile storage functions. </p>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ga3ed5adfa11e69215662fb393fd98c254"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool rt_flash_busy </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Check if flash is running an operation. </p>
<dl class="section return"><dt>Returns</dt><dd>True if flash is busy. </dd>
<dd>
False otherwise. </dd></dl>

<p>Definition at line <a class="el" href="ruuvi__task__flash_8c_source.html#l00227">227</a> of file <a class="el" href="ruuvi__task__flash_8c_source.html">ruuvi_task_flash.c</a>.</p>

</div>
</div>
<a class="anchor" id="ga88b74f81127b1cab4fc6fd714e3cbcde"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group___error.html#ga3e1919cc1fe75cb7f12af047f6f4ce55">rd_status_t</a> rt_flash_free </td>
          <td>(</td>
          <td class="paramtype">const uint16_t&#160;</td>
          <td class="paramname"><em>file_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint16_t&#160;</td>
          <td class="paramname"><em>record_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Free data from flash. </p>
<p>The flash storage implements a simple file system, where data is arranged to files which have records. You can for example have a file for sensor configurations and record for each sensor.</p>
<p>This function does not physically erase the data, it only marks the record as deleteable for garbage collection.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">file_id</td><td>ID of a file to delete. Valid range 1 ... 0xBFFF </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">record_id</td><td>ID of a record to delete. Valid range 1 ... 0x</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>RD_SUCCESS on success. </dd>
<dd>
RD_ERROR_INVALID_STATE if flash is not initialized. </dd>
<dd>
RD_ERROR_BUSY if another operation was ongoing. </dd>
<dd>
RD_ERROR_NOT_FOUND if given record was not found.</dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>triggers garbage collection if there is no space available, which leads to long processing time. </dd></dl>

</div>
</div>
<a class="anchor" id="ga4f22c6d5f9c1b27a03870d46dde214c2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group___error.html#ga3e1919cc1fe75cb7f12af047f6f4ce55">rd_status_t</a> rt_flash_gc_run </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Trigger garbage collection. </p>
<p>Free up space in flash by erasing old records. It's generally a good idea to check remaining space on flash after a write and trigger GC if the space remaining is smaller than expected record sizes. This function physically erases the records which are garbage collected. Waits until GC can be triggered, and returns when GC operation has been queued.</p>
<dl class="section return"><dt>Returns</dt><dd>RD_SUCCESS on success. </dd>
<dd>
RD_ERROR_INVALID_STATE if flash is not initialized. </dd></dl>

</div>
</div>
<a class="anchor" id="ga5d38001292abc41bab659d2b6da1691c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group___error.html#ga3e1919cc1fe75cb7f12af047f6f4ce55">rd_status_t</a> rt_flash_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize flash storage. </p>
<p>If flash initialization fails, flash is purged and device tries to enter bootloader.</p>
<dl class="section return"><dt>Returns</dt><dd>RD_SUCCESS on success </dd>
<dd>
error code from stack on error </dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>Erases entire flash storage and reboots on failure. </dd></dl>

<p>Definition at line <a class="el" href="ruuvi__task__flash_8c_source.html#l00208">208</a> of file <a class="el" href="ruuvi__task__flash_8c_source.html">ruuvi_task_flash.c</a>.</p>

</div>
</div>
<a class="anchor" id="ga8f66597592c4c5d6bf0c62c7967f75e2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group___error.html#ga3e1919cc1fe75cb7f12af047f6f4ce55">rd_status_t</a> rt_flash_load </td>
          <td>(</td>
          <td class="paramtype">const uint16_t&#160;</td>
          <td class="paramname"><em>file_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint16_t&#160;</td>
          <td class="paramname"><em>record_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *const&#160;</td>
          <td class="paramname"><em>message</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const size_t&#160;</td>
          <td class="paramname"><em>message_length</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Load data from flash. </p>
<p>The flash storage implements a simple file system, where data is arranged to files which have records. You can for example have a file for sensor configurations and record for each sensor.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">file_id</td><td>ID of a file to load. Valid range 1 ... 0xBFFF </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">record_id</td><td>ID of a record to load. Valid range 1 ... 0x </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">message</td><td>Data to load. Must be aligned to a 4-byte boundary. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">message_length</td><td>Length of loaded data. Maximum 4000 bytes per record on nRF52.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>RD_SUCCESS on success. </dd>
<dd>
RD_ERROR_NULL if data pointer is NULL. </dd>
<dd>
RD_ERROR_INVALID_STATE if flash is not initialized. </dd>
<dd>
RD_ERROR_BUSY if another operation was ongoing. </dd>
<dd>
RD_ERROR_NOT_FOUND if given record was not found. </dd>
<dd>
RD_ERROR_DATA_SIZE if record exceeds maximum size.</dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>triggers garbage collection if there is no space available, which leads to long processing time. </dd></dl>

<p>Definition at line <a class="el" href="ruuvi__task__flash_8c_source.html#l00221">221</a> of file <a class="el" href="ruuvi__task__flash_8c_source.html">ruuvi_task_flash.c</a>.</p>

</div>
</div>
<a class="anchor" id="gad44b23bace6d3792869483d1e99aa778"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group___error.html#ga3e1919cc1fe75cb7f12af047f6f4ce55">rd_status_t</a> rt_flash_store </td>
          <td>(</td>
          <td class="paramtype">const uint16_t&#160;</td>
          <td class="paramname"><em>file_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint16_t&#160;</td>
          <td class="paramname"><em>record_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *const&#160;</td>
          <td class="paramname"><em>message</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const size_t&#160;</td>
          <td class="paramname"><em>message_length</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Store data to flash. </p>
<p>The flash storage implements a simple file system, where data is arranged to files which have records. You can for example have a file for sensor configurations and record for each sensor. Underlying implementation provides wear leveling. Garbage collection may be triggered manually and is tried automatically if there is not enough space in flash. This function only queues the data to be written, you must verify that write was completed before freeing message.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">file_id</td><td>ID of a file to store. Valid range 1 ... 0xBFFF </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">record_id</td><td>ID of a record to store. Valid range 1 ... 0x </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">message</td><td>Data to store. Must be aligned to a 4-byte boundary. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">message_length</td><td>Length of stored data. Maximum 4000 bytes per record on nRF52.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>RD_SUCCESS on success. </dd>
<dd>
RD_ERROR_NULL if data pointer is NULL. </dd>
<dd>
RD_ERROR_INVALID_STATE if flash is not initialized. </dd>
<dd>
RD_ERROR_BUSY if another operation was ongoing. </dd>
<dd>
RD_ERROR_NO_MEM if there was no space for the record in flash. </dd>
<dd>
RD_ERROR_DATA_SIZE if record exceeds maximum size.</dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>triggers garbage collection if there is no space available, which leads to long processing time. </dd></dl>

<p>Definition at line <a class="el" href="ruuvi__task__flash_8c_source.html#l00215">215</a> of file <a class="el" href="ruuvi__task__flash_8c_source.html">ruuvi_task_flash.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
